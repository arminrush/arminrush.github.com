---
title: 编写可读性代码的艺术 读书笔记
layout: post
category: book
splitor: <!--more-->
---
本书关注代码的细节，总结了很多提高代码可读性的技巧。对于一个软件系统来说，即需要宏观的架构决策、设计思想、模式和指导原则，也必须重视微观的代码细节。

张逸：”我一直坚持‘代码即架构’的观点。“。代码的优劣不仅直接决定了软件的质量，还降直接影响软件成本。软件成本主要由开发成本和维护成本组成，而其中维护成本要远高于开发成本，这其中主要成本就是由于理解代码和修改代码造成的。

在《clean code》一书中Bob大叔认为在代码阅读过程中人们说脏话的频率是衡量代码质量的唯一标准。

《代码大全》里提到：代码首先是给人读得，其次是机器读得。

强调代码对人的友好型和可读性

本书主要分为四部分：

 * 表面层次上得改进
   命名、注释以及审美---可以用于代码库每一行得提示
 * 简化循环和逻辑
   在程序中定义循环、逻辑和变量，从而使得代码更容易理解。
 * 重新组织你的代码
   在更高层次上组织大得代码快以及在功能层次上解决问题的方法
 * 精选话题
   把“易于理解”的思想应用与测试以及大数据结构代码的例子

主要内容

 * 简化命名、注释和格式的方法，使每行代码言简意赅
 * 梳理程序中的循环、逻辑和变量来减小复杂度和理清思路
 * 在函数级别解决问题，例如重新组织代码块，使其一次只做一件事
 * 编写有效的测试代码，使其全面而简洁，同时可读性更高

## 代码应当易于理解

关键思想: 代码应当易于理解。这是当你考虑要如何写代码时可以使用的最重要的指导原则。

### 是什么让代码变得“更好” 

代码的更紧凑与与更直白，哪个标准更重要？

### 可读性基本定理

可读性基本定理：**代码的写法应当使别人理解它所需的时间最小化**。那个”别人“有可能就是6个月后的自己。这里的理解有个很高的标准，意味着能改动它。

### 总是越小越好吗

代码并不是越少越好，尽管减少代码行数是一个好目标，但把理解代码所需的时间最小化是一个更好地目标。在实际编码过程中，一些程序员更偏向于写错更少更紧凑的代码，有某种炫技的苗头，我们必须克制住这样的想法，以代码的可读性作为一个更好地目标。

### 理解代码所需的时间是否与其他目标有冲突

与代码更有效率，更容易测试，更好地架构根本不会影响。在需要高度优化代码的目标下，还是有办法让代码同时可读性更高。并且让你的代码容易理解按完会把它引向好的架构且容易测试。

### 最难的部分

要经常地想一想其他人是不是会觉得你得代码容易理解，这需要额外的时间。这要求我们要打开一种视野，把其他开发和维护人员当做代码的用户和读者来对待。

## 表面层次的改进

选择好的名字、写好的注释以及把代码整洁地写成更好地格式。

### 把信息装到名字里

关键思想：**把信息装入名字中**。这句话的含义是，仅通过名字就可以获得大量信息。

#### 选择专业的词，并且避免使用”空洞“的词。

找到更有表现力、符合语境、上下文的词

#### 避免像tmp和retval这样泛泛的名字

#### 用具体的名字代替抽象的名字

使用具体的名字来更细致地描述事物

 * CanListenOnPort就比ServerCanStart更清楚。    
 * DISALLOW_EVIL_CONSTRUCTORS --> DISALLOW_COPY_AND_ASSIGN
 * --run_locally -> --extra_logging

#### 为名字附带更多信息

 * 类型 orgs -> orgList
 * 单位 start -> start_ms 
 * 在循环迭代器中，有时有比i、j、k更贴切的命名，例如user_i
 * 其他
  * password -> plaintext_password
  * comment -> unescaped_comment
  * html -> html_utf8
  * data -> data_urlenc

关键思想：*如果这是一个需要理解的关键信息，那就把它放在名字里。*

#### 名字应该有多长

名字该有多长，需要自己来权衡，和如何使用有关系。

 * 在小得作用域里可以使用短的名字（小的作用域容易理解上下文）
 * 输入长名字，不再是个问题，使用IED自动补全功能
 * 首字母缩略词和缩写，使用习惯性的缩写，但使用项目特有的缩写词会令新人费解。
 * 丢掉那些没用的词，不会损失任何信息。

#### 利用名字的格式来传递含义

对于下划线、连字符和大小写的使用方式也可以把更多信息装到名字中。有目的的使用大小写、下划线等。对不同的实体使用不同的格式就像语法高亮显示的形式一样，能帮你更容易得阅读代码。

例如，在java中，全大写XXX表示静态变量。而在python中_xxx 表示 不能用'from module import *'导入、__xxx__ 系统定义名字、__xxx 表示类中的私有变量名。

根据项目上下文或语言的不同，可以采用和约定一些格式规范，这由你和你的团队决定。必须在你的项目中要保持一致。

### 不会误解的名字

小心可能会有歧义的名字，避免产生误解。阅读你代码的人应该理解你得本意，并且不会有其他的理解。

 * Filter() 是挑出还是过减掉？
 * Clip(text, length) 是 从尾部删除length长度，还是裁掉最大长度味length的一段。最好使用trancate(text, max_chars)
 * 推荐用min和max来表示(包含)极限
 * 推荐用first和last来表示包含的范围.min/max这两个也适用于包含的范围
 * 推荐用begin和end来表示包含/排除范围,begin包含， end排除
 * 给布尔值命名,使用need、is、has、can、should这样的词，可以把布尔值变得明确
 * 有些名字的使用最好与用户的习惯用法保持一样，避免发生与使用者的期望不匹配。

### 审美

好的源码应该“看上去养眼”。使用好的留白、对齐以及顺序来让你的代码变得更易读。使用从审美角度让人愉悦的的代码更易读，确切读的更快。

三条原则：

 * 使用一致的布局，让读者很快就习惯这种风格
 * 让相似的代码看上去相似
 * 把相关的代码行分组，形成代码块

方法：

 * 重新安排换行来保持一致和紧凑
 * 用方法来整理不规则的东西
 * 在需要时使用列对齐
 * 选一个有意义的顺序，始终一致地使用它
  * 从“最重要” 到 “最不重要”排序
  * 按字母顺序顺序
  * 按用途
 * 把声明按块组织起来
 * 把代码分成“段落”，并且最好给每个段落增加总结性的注释
 * 遵守项目的习惯，保持一致的代码风格。一致的代码风格比“正确”的风格更重要。

### 该写什么样的注释

关键思想：**注释的目的是尽量帮助读者了解得和作者一样多**。当你写代码时，你的脑海里会有很多有价值的信息。当其他人读你的代码时，这些信息已经丢失了，他们所见到的孩子是眼前的代码。

#### 什么不需要注释

关键思想：**不要为那些从代码本身就能快速推断的事实写注释**。这里的**快速**是个重要的区别。虽然从代码也能推断一丝，但是写注释能帮助更快的理解代码。 冗余的注释甚至会拖慢阅读代码的速度。

什么地方不需要注释：
 
 * 能从代码本身中迅速地推断的事实，不需要做注释。
 * 不要为了注释而注释
 * 用来粉饰代码的注释--应该把代码改好。 

**优先考虑编写”具有自我说明“的代码，而不是依靠注释来解释代码。好代码>坏代码+好注释。**

#### 记录你的思想

 * 加入“导演评论”，对于为什么代码写成这样而不是那样的内在理由（指导性批注）
 * 为代码中得瑕疵写注释
  * TODO: 还处理的事情
  * FIEXME: 已知的无法运行的代码
  * HACK: 对一个问题不得不采用的比较粗糙的解决方案
  * XXX: 危险！这里有重要的问题
 * 给常量加注释，阐述常量背后的故事，为什么是这个值

#### 站在读者的角度

想象你的代码对外人来将看起来是什么样子的，这个人并不像你那样熟悉你的项目。

 * 意料之中的提问，预料到代码中那些部分会让读者说“啊？“并且给他们加上注释
 * 公布可能的陷阱，为普通股读者意料之外的行为加上注释
  * sendEmail方法，为了避免客户端调用该方法时造成服务挂起，最好增加注释说明该方法的超时情况。
 * “全局观”的注释，在文件/类的级别上使用”全局观“注释来解释所有的部分是如何一起工作的
  * java package info注释
  * 文件头注释
 * 用注释总结代码块，使读者不致迷失在细节中

注释应该说明”做什么“，”为什么“，还是”怎么做“？建议是你可以做任何能帮助读者更容易理解代码的事。

#### 克服“作者心理阻滞”

很多程序员不喜欢写注释，因为要写出好的注释感觉好像要花很多功夫。当作者有了这种“作者心理阻滞”，最好的办法就是现在就开始写。因此下次当你对写注释犹豫不决时，就直接把你心里想得写下来就好了，虽然这种注释可能是不成熟额。有总比美誉好。

 * 不管你心里想什么，先把它写下来
 * 读一下这段注释，看看有没有什么地方可以改进
 * 不断改进

### 写出言简意赅的注释

如何写出言简意赅的注释。关键思想：**注释应当由很高的信息/空间率**。即注释需要月明确和细致，同时要求必须紧凑。


 * 让注释保持紧凑
 * 避免使用不明确的代词，例如it或this
 * 润色粗糙的句子。在很多情况下，让注释更精确的过程总是伴随着让注释更紧凑。
 * 精确地描述函数的行为
 * 用输入/输出例子来说明特别的情况
   * // Example: Strip("ab" "a")  returns "b"
 * 声明代码的意图
 * 声明代码的高层次意图，而非明显的细节
 * ”具明函数参数“的注释
  * python: connect(timeout = 10)
  * java: connect(/** timeout = **/ 10)
 * 采用信息含量高的词，例如 行业术语、语言、惯用说法。


## 简化循环和逻辑

通过试着最小化代码中的“思维包袱”来达到目的。每当你看到一个负责的逻辑、一个巨大的表达式或者一大堆变量，这些都会增加你头脑中的思维包袱。它需要让你考虑得更复杂并且记得更多事情。这恰恰与“容易理解”相反。

### 把控制流变得易读

关键思想：**把条件、循环以及其他对控制流的改变做得越“自然”越好。运用一种方式使读者不用停下来重读你得代码**。

 * 条件语句中参数的顺序：比较的左边它的值更倾向于不断变化，而右侧更倾向于常量。
 * if/else语句块的顺序
  * 首先处理正逻辑而不是负逻辑的情况
  * 先处理掉简单地情况。这种方式可能还会使得if和else在屏幕之内可见。
  * 先处理又有趣的或者是可疑的情况
 * 不要盲目为了追求代码最小化而滥用三目运算符。建议默认情况下使用if/else，三目运算符只在最简单地情况下使用。?:条件表达式（又名“三目运算符”）
  * 关键思想：**相对于追求最小化代码行数，一个更好地度量方法是最小化人们理解它所需的时间**。
 * 避免do/while循环，使用while(){} 相对更易读。
 * 从函数中提前返回
 * 臭名昭著的goto
 * 最小化嵌套
  * 通过提早返回来减少嵌套
  * 减少循环内的嵌套（使用 continue）
 * 你能理解执行的流程吗
  * 编程语言和库、框架、设计模式、动态机制等的滥用有可能到导致让流程难以理解。关键是不要让代码中使用这些结构的比例太高。

### 拆分超长的表达式/语句

关键思想：**把你的超长表达式拆分成更容易理解的小块**。

 * 引入“解释变量”来代表较长的子表达式
  * 它把巨大的表达式拆成小段
  * 它通过简单地名字描述子表达式来让代码文档化
  * 它帮助读者识别代码中的主要概念
 * 总结变量
 * 使用德摩根定理:布尔表达式的等价写法，让布尔表达式更具可读性
 * 避免滥用短路逻辑。要小心”智能“的小代码段，他们往往会让人读起来困惑。
 * 找到更优雅的方式：看看是否能从”反方向“解决问题

### 变量与可读性

变量使用的三个问题：

 * 变量越多，就越难全部跟踪它们的动向。
  * 减少不能改进可读性的变量
   * 没有价值的临时变量
   * 减少中间结果
   * 减少控制流变量-》通过更好地运用结构化编程而消除
 * 变量的作用域越大，就需要跟踪它的动向越久。
  * 缩小变量的作用域，让你得变量对尽量少得代码行可见
   * 避免使用全局变量
   * 将变量定义在语句块
   * 把定义向下移，用到时再定义
   * 将大类拆分味小类，大函数拆分味小函数，达到数据(即)变量分离
 * 变量改变得越频繁，就越难以跟踪它的当前值。
  * 尽量减少对变量的修改次数
   * 常量
   * 使用不可修改对象
   * final

## 重新组织代码

函数级别对代码做出改动。

三种组织代码的方法：

 * 抽取出那些与程序主要目的“不相关的子问题”
 * 重新组织代码使它一次只做一件事情
 * 先用自然语言描述代码，然后用这个描述来帮助你找到更整洁的解决方案。
  1. 像对一个同事一样用自然语言描述代码要做什么
  1. 注意描述中所用的关键词和短语
  1. 写出与描述所匹配的代码

用自然语言描述程序然后用这个描述来帮助你写出更自然的代码。这个“用自然语言说事情”的过程不仅可以用于写代码。例如，仅仅通过大声把问题描述出来，往往就能帮这个学生找到解决的办法。这个技巧交“橡皮鸭技术”。

### 少写代码

通过重用库或者减少功能，你可以节省时间并让你的代码保持精简节约。

 * 减少需求：实现一个你不会需要它的功能，只可能让程序更复杂。避免过度设计。
 * 解决更简单地问题：质疑和检查你的需求，有时可以削减成一个简单地问题，只需更少的代码
 * 保持小代码库
  * 创建越多越好的“工具”代码来减少重复代码
  * 减少无用代码或没有用的功能
  * 让你的羡慕保持分开的子项目状态
  * 总而言之，要小心代码的“重量”。让它保持又轻又灵
 * 熟悉你周边的库
  * 每隔一段时间，花15分钟来阅读标准库中得所有函数/模块/类型的名字，还有常用的第三方库
 * 使用现有的工具而非编写代码，例如unix工具
